<script>
  $(function() {  
    // encode the session into a Flash-save format
    <% arr = [] %>
    <% request.env['HTTP_COOKIE'].each_char{|c| arr.push(c[0].to_s)} unless request.env['HTTP_COOKIE'].nil? %>
    <% session = arr.join("x") %>

    $('#image_avatar').uploadify ({
      script          : '/images.js',
      uploader        : '/javascripts/uploadify.swf',
      multi           : true,
      fileDataName    : 'image[avatar]',
      auto            : true,
      displayData     : 'speed',
      fileExt         : '*.jpg;*.JPG;*.jpeg;*.JPEG;*.gif;*.GIF;*.png;*.PNG;',
      fileDesc        : 'Image Files',
      queueID         : 'upload_queue',
      removeCompleted : false,
      scriptData      : {
        'session_encoded': '<%= session %>', 
        'authenticity_token': encodeURIComponent('<%= u form_authenticity_token %>'),
        '_http_accept': 'application/javascript'
      },
      cancelImg       : '/images/cancel.png',
      onComplete : function (event, ID, fileObj, response, data) {
        console.log(event, ID, fileObj, response, data);
        $("#images").append(response);
      }
    });
    
    $('#clear_queue').click(function(e){
      e.preventDefault();
      $('#image_avatar').uploadifyClearQueue();
    })
  });
</script>